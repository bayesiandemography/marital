
DENOM = 1000
AGE_MAX = 75
PC_IMPUTED = 0.025
BURN = 100
SIM = 100
THIN = 1
CHAIN = 4

.PHONY: all
all: all_fig.pdf \
     out/fig_mcmc_population.pdf \
     out/fig_mcmc_births.pdf \
     out/fig_mcmc_internal.pdf \
     out/fig_mcmc_deaths.pdf


## Prepare data

out/population_cb.rds : src/population_cb.R \
                    data/census_data_20190327_5c9c3633ee912.csv
	Rscript $< --denom $(DENOM)

out/married_df.rds : src/married_df.R \
                     data/World_Marriage_Data_2015.xlsx
	Rscript $< --pc_imputed $(PC_IMPUTED)

out/popn_df.rds : src/popn_df.R \
                  data/PopulationAgeSex-20171128124220.xlsx
	Rscript $< --denom $(DENOM)

out/married_1990.rds : src/married_1990.R \
                       out/popn_df.rds \
                       out/married_df.rds
	Rscript $<

out/married_1995_2010.rds : src/married_1995_2010.R \
                            out/popn_df.rds \
                            out/married_df.rds
	Rscript $<

out/births_un.rds : src/births_un.R \
                    data/NumberBirthsAgeMother-20171130020714.xlsx
	Rscript $< --denom $(DENOM)

out/births_cb.rds : src/births_cb.R \
                    data/census_data_20190327_5c9c35cc5727c.csv \
                    data/census_data_20190327_5c9c35eb3d35a.csv
	Rscript $< --denom $(DENOM)

out/deaths_un.rds : src/deaths_un.R \
                    data/NumberDeaths-20171201121407.xlsx
	Rscript $< --denom $(DENOM) \
                   --age_max $(AGE_MAX)

out/deaths_cb.rds : src/deaths_cb.R \
                    data/census_data_20190327_5c9c35cc5727c.csv \
                    data/census_data_20190327_5c9c35eb3d35a.csv
	Rscript $< --denom $(DENOM)

out/marriages_divorces_df.rds : src/marriages_divorces_df.R \
                                data/Marriage_Divorce.csv
	Rscript $< --denom $(DENOM)

out/marriages_divorces.rds : src/marriages_divorces.R \
                             out/marriages_divorces_df.rds
	Rscript $< --denom $(DENOM)

out/remarriages.rds : src/remarriages.R \
                      out/marriages_divorces_df.rds
	Rscript $<

out/conc_remarriage.rds : src/conc_remarriage.R
	Rscript $<


## General plotting

out/plot_theme.rds : src/plot_theme.R
	Rscript $<


## Graphs and tables of data

out/fig_data_marital_status.pdf : src/fig_data_marital_status.R \
                                  out/married_1990.rds \
                                  out/married_1995_2010.rds \
                                  out/plot_theme.rds
	Rscript $< --denom $(DENOM)

out/fig_data_marriage_divorce.pdf : src/fig_data_marriage_divorce.R \
                                    out/marriages_divorces_df.rds \
                                    out/plot_theme.rds
	Rscript $< --denom $(DENOM)

out/fig_data_births_un.pdf : src/fig_data_births_un.R \
                             out/births_un.rds \
                             out/plot_theme.rds
	Rscript $< --denom $(DENOM)

out/tab_data_births_un_cb.tex : src/tab_data_births_un_cb.R \
                                out/births_un.rds \
                                out/births_cb.rds
	Rscript $< --denom $(DENOM)

out/fig_data_deaths_un.pdf : src/fig_data_deaths_un.R \
                             out/deaths_un.rds \
                             out/plot_theme.rds
	Rscript $< --denom $(DENOM)

out/tab_data_deaths_un_cb.tex : src/tab_data_deaths_un_cb.R \
                                out/deaths_un.rds \
                                out/deaths_cb.rds
	Rscript $< --denom $(DENOM)


## Decompositions of datasets

out/decomp_married.rds : src/decomp_married.R \
                         out/married_1990.rds \
                         out/married_1995_2010.rds
	Rscript $<

out/decomp_births.rds : src/decomp_births.R \
                        out/births_un.rds \
                        out/population_cb.rds
	Rscript $<

out/decomp_deaths.rds : src/decomp_deaths.R \
                        out/deaths_un.rds \
                        out/population_cb.rds
	Rscript $<



## Set up model

out/datasets.rds : src/datasets.R \
                   out/married_1990.rds \
                   out/married_1995_2010.rds \
                   out/births_un.rds \
                   out/deaths_un.rds \
                   out/marriages_divorces.rds \
                   out/remarriages.rds
	Rscript $<

out/concordances.rds : src/concordances.R \
                       out/conc_remarriage.rds
	Rscript $<

out/data_models.rds : src/data_models.R
	Rscript $<

out/system_models.rds : src/system_models.R
	Rscript $<

out/account.rds : src/account.R \
                  out/married_1990.rds \
                  out/births_un.rds \
                  out/deaths_un.rds \
                  out/marriages_divorces.rds \
                  out/remarriages.rds
	Rscript $<


## Run model

out/model.est : src/model.R \
                out/account.rds \
                out/system_models.rds \
                out/datasets.rds \
                out/data_models.rds \
                out/concordances.rds
	Rscript $< --n_burnin $(BURN) --n_sim $(SIM) --n_chain $(CHAIN) --n_thin $(THIN)



## Traceplots for demographic series

out/fig_mcmc_population.pdf : src/fig_mcmc.R \
                              out/model.est
	Rscript $< --series population

out/fig_mcmc_births.pdf : src/fig_mcmc.R \
                          out/model.est
	Rscript $< --series births

out/fig_mcmc_internal.pdf : src/fig_mcmc.R \
                            out/model.est
	Rscript $< --series internal

out/fig_mcmc_deaths.pdf : src/fig_mcmc.R \
                          out/model.est
	Rscript $< --series deaths



## Plots of estimates for demographic series

out/fig_est_population_single.pdf : src/fig_est_population.R \
                                    out/model.est
	Rscript $< --status Single

out/fig_est_population_married.pdf : src/fig_est_population.R \
                                     out/model.est
	Rscript $< --status Married

out/fig_est_population_divorced.pdf : src/fig_est_population.R \
                                      out/model.est
	Rscript $< --status Divorced

out/fig_est_population_widowed.pdf : src/fig_est_population.R \
                                     out/model.est
	Rscript $< --status Widowed


out/fig_est_births_count.pdf : src/fig_est_births_count.R \
                               out/model.est
	Rscript $<


out/fig_est_births_rate.pdf : src/fig_est_births_rate.R \
                              out/model.est
	Rscript $<


out/fig_est_internal_count_single_married.pdf : src/fig_est_internal_count.R \
                                                out/model.est
	Rscript $< --status_orig Single --status_dest Married

out/fig_est_internal_count_divorced_married.pdf : src/fig_est_internal_count.R \
                                                  out/model.est
	Rscript $< --status_orig Divorced --status_dest Married

out/fig_est_internal_count_widowed_married.pdf : src/fig_est_internal_count.R \
                                                 out/model.est
	Rscript $< --status_orig Widowed --status_dest Married

out/fig_est_internal_count_married_divorced.pdf : src/fig_est_internal_count.R \
                                                  out/model.est
	Rscript $< --status_orig Married --status_dest Divorced

out/fig_est_internal_count_married_widowed.pdf : src/fig_est_internal_count.R \
                                                  out/model.est
	Rscript $< --status_orig Married --status_dest Widowed


out/fig_est_internal_rate_single_married.pdf : src/fig_est_internal_rate.R \
                                               out/model.est
	Rscript $< --status_orig Single --status_dest Married

out/fig_est_internal_rate_divorced_married.pdf : src/fig_est_internal_rate.R \
                                                 out/model.est
	Rscript $< --status_orig Divorced --status_dest Married

out/fig_est_internal_rate_widowed_married.pdf : src/fig_est_internal_rate.R \
                                                out/model.est
	Rscript $< --status_orig Widowed --status_dest Married

out/fig_est_internal_rate_married_divorced.pdf : src/fig_est_internal_rate.R \
                                                 out/model.est
	Rscript $< --status_orig Married --status_dest Divorced

out/fig_est_internal_rate_married_widowed.pdf : src/fig_est_internal_rate.R \
                                                out/model.est
	Rscript $< --status_orig Married --status_dest Widowed


out/fig_est_deaths_count_single.pdf : src/fig_est_deaths_count.R \
                                      out/model.est
	Rscript $< --status Single

out/fig_est_deaths_count_married.pdf : src/fig_est_deaths_count.R \
                                       out/model.est
	Rscript $< --status Married

out/fig_est_deaths_count_divorced.pdf : src/fig_est_deaths_count.R \
                                        out/model.est
	Rscript $< --status Divorced

out/fig_est_deaths_count_widowed.pdf : src/fig_est_deaths_count.R \
                                       out/model.est
	Rscript $< --status Widowed


out/fig_est_deaths_rate_single.pdf : src/fig_est_deaths_rate.R \
                                     out/model.est
	Rscript $< --status Single

out/fig_est_deaths_rate_married.pdf : src/fig_est_deaths_rate.R \
                                      out/model.est
	Rscript $< --status Married

out/fig_est_deaths_rate_divorced.pdf : src/fig_est_deaths_rate.R \
                                       out/model.est
	Rscript $< --status Divorced

out/fig_est_deaths_rate_widowed.pdf : src/fig_est_deaths_rate.R \
                                      out/model.est
	Rscript $< --status Widowed





## Documents

all_fig.pdf : all_fig.Rmd \
              out/population_cb.rds \
              out/married_1990.rds \
              out/married_1995_2010.rds \
              out/births_un.rds \
              out/births_cb.rds \
              out/deaths_un.rds \
              out/deaths_cb.rds \
              out/marriages_divorces_df.rds \
              out/remarriages.rds \
              out/fig_data_married.pdf \
              out/fig_data_marriage_divorce.pdf \
              out/decomp_married.rds \
              out/decomp_births.rds \
              out/decomp_deaths.rds
	Rscript -e 'knitr::knit("all_fig.Rmd")'
	Rscript -e 'rmarkdown::render("all_fig.md")'
	rm all_fig.md
	rm -rf all_fig_files
	rm -rf figure


bda.tex : bda.Rnw \
          out/tab_data_births_un_cb.tex \
          out/tab_data_deaths_un_cb.tex
	Rscript -e "knitr::knit('$<')"

bda.pdf : bda.tex \
          out/fig_data_marriage_divorce.pdf \
          out/fig_data_marital_status.pdf \
          out/fig_data_births_un.pdf \
          out/fig_data_deaths_un.pdf
	pdflatex -interaction=batchmode bda
	pdflatex -interaction=batchmode bda



plots_estimates.pdf : plots_estimates.tex \
                      out/fig_est_population_single.pdf \
                      out/fig_est_population_married.pdf \
                      out/fig_est_population_divorced.pdf \
                      out/fig_est_population_widowed.pdf \
                      out/fig_est_births_count.pdf \
                      out/fig_est_births_rate.pdf \
                      out/fig_est_internal_count_single_married.pdf \
                      out/fig_est_internal_count_divorced_married.pdf \
                      out/fig_est_internal_count_widowed_married.pdf \
                      out/fig_est_internal_count_married_divorced.pdf \
                      out/fig_est_internal_count_married_widowed.pdf \
                      out/fig_est_internal_rate_single_married.pdf \
                      out/fig_est_internal_rate_divorced_married.pdf \
                      out/fig_est_internal_rate_widowed_married.pdf \
                      out/fig_est_internal_rate_married_divorced.pdf \
                      out/fig_est_internal_rate_married_widowed.pdf \
                      out/fig_est_deaths_count_single.pdf \
                      out/fig_est_deaths_count_married.pdf \
                      out/fig_est_deaths_count_divorced.pdf \
                      out/fig_est_deaths_count_widowed.pdf \
                      out/fig_est_deaths_rate_single.pdf \
                      out/fig_est_deaths_rate_married.pdf \
                      out/fig_est_deaths_rate_divorced.pdf \
                      out/fig_est_deaths_rate_widowed.pdf
	pdflatex -interaction=batchmode plots_estimates
	pdflatex -interaction=batchmode plots_estimates



.PHONY: clean
clean:
	rm -rf out
	mkdir out
	rm -rf figure


.PHONY: cleanfig
cleanfig:
	rm -f out/fig*
